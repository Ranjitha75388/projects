# Azure Storage

## What is Azure Storage?

- Azure Storage is a cloud storage solution from Microsoft that offers various services for storing and managing different types of data, including unstructured, semi-structured, and structured data.
- It provides scalable, durable, and highly available services.

## Types of Storage in Azure:

 - Blob Storage – Stores unstructured data like text or binary (images, videos, documents).

 - File Storage – Shared file system (like SMB).

- Queue Storage – For message queuing between services.

- Table Storage – NoSQL key-value store.

##  What is Blob Storage?

   Blob (Binary Large Object) Storage is used to store : Images, documents, videos, backups, logs, large datasets, etc.

  #### Blob Types:

   -  Block blobs – For files like text, images.

   - Append blobs – For logging data.

   - Page blobs – For virtual hard drives (used in Azure VMs).

# 1. Public Access to Azure Blob Storage
  **Use case**: Anyone (even outside Azure) can access blobs via URL/SAS.
  
**Step 1:** Go to Azure Portal --> Storage Accounts --> Create

   ![image](https://github.com/user-attachments/assets/f5a37ad9-9cf4-4d1d-a8b3-854fefe68022)

**Step 2:** Choose **"Enable public access from all networks"** under Networking
   
  ![image](https://github.com/user-attachments/assets/2d4725d2-d38d-4e0d-bcd1-7ccb2aa3353a)


 **Step 3:** Create Container

  -  Go to Data Storage > Containers

  -  Create a container

   ![image](https://github.com/user-attachments/assets/1eb24987-3774-4c78-ae0a-acc31c75c100)


**Step 4:** Check and Change access level to "Blob (anonymous read access for blobs only)"  if it is private access.
  
- Go to configuration > enable blob anonymous access 

- Go to container > 3 dots > change access level > blob

![image](https://github.com/user-attachments/assets/c444db26-4daa-4e34-a9d4-071c07b66e13)

**Step 5:** Upload Blob/File

- Click created container
- Click upload
- Browse for files
- Select file that have to upload from local
- After uploading

![image](https://github.com/user-attachments/assets/b4407a9c-94bc-4e2d-9699-7f005535cb99)

**Step 6:** Access Using URL or Tools:

### Browser

Go to blob file in portal → click → Copy Blob URL → Open in browser

![image](https://github.com/user-attachments/assets/13219fc7-cd2a-469a-8b65-974b39f2faef)

### AzCopy (No login needed with public access)

1. List blobs:
```
  azcopy list "https://<storage_account>.blob.core.windows.net/<container>?<sas-token>"
```
- Command used for testing
```
  azcopy list "https://azurestorageaccountdemoo.blob.core.windows.net/container?sp=rl&st=2025-04-17T08:44:05Z&se=2025-04-17T16:44:05Z&spr=https&sv=2024-11-04&sr=c&sig=rFlxYok3ibRu65CyjHDcvQR2EF%2FYXAWXJLoXjBG87P0%3D"
```
- Local-vm:
![image](https://github.com/user-attachments/assets/95dfa576-dd68-4871-80aa-8a2dd8ac1f1f)

- Public-vm:
![image](https://github.com/user-attachments/assets/23eea785-589a-4742-a755-ed567deb08f5)

- Private-vm:
![image](https://github.com/user-attachments/assets/c29aec29-8391-4913-b091-0c959b575d13)

2.Download blob:
```
 azcopy cp "https://<storage_account>.blob.core.windows.net/<container>/<file>" "/your/local/path/"
```
![image](https://github.com/user-attachments/assets/e834a279-00e1-4112-aba6-4aac6be2c7ce)


#  2. Secure Access Using Service Endpoint

 **Use case:** Restrict blob access to only VMs in a selected subnet inside a VNet.

![image](https://github.com/user-attachments/assets/ea526e4a-d6aa-447d-8954-1b1439fbc357)


**Step 1:** Create VNet and Subnet
   
  1. Create public subnet and Attach NSG for public vm.
  2. Create and Enable **private subnet** and Enable **Microsoft.Storage** as a Service Endpoint,Attach **NAT**and **NSG** for private vm.

   ![image](https://github.com/user-attachments/assets/a6953692-452b-4198-a986-f1692ea4afd2)


 **Step 2:** Create public vm and Private VM (No public IP)

 **Step 3:** Update NSG

 1. Alllow NSG form public to public vm
 2. Allow traffic from public VM to private vm

**Step 4:** Create Storage Account

 - Create storage Account : serviceendpointaccount
 - Create container : service-container
 - Check blob anonymous access is disabled under "configuration" for private access.
 - Under **Networking,** select:
   - Enabled from selected virtual networks and IP addresses
   - virtual networks > Add existing virtual network > vnet -> subnet attached service endpoint(private-vm subnet)
  
 ![image](https://github.com/user-attachments/assets/88a069b4-a4b8-4d8a-a44a-a3e70844704a)

**Step 5:** Upload File to Container

**Step 6:** Generate SAS Token

- Go to blob → 3 dots → Generate SAS
- Select Read permission, expiry time

  ![image](https://github.com/user-attachments/assets/07449fa9-3c38-4fad-b03e-62a3a695efdb)

**Step 7:** Deny public ip access to storage account from public vm

![image](https://github.com/user-attachments/assets/bb4cae30-10b6-4d3a-a9a3-7cbd10e604f1)


public ip is: 103.175.108.90
az storage account show --name serviceendpointaccount --query networkRuleSet

**Step 8**: Access from Private VM using SAS:

- ssh to private vm from public vm.

```
curl "https://<storage_account>.blob.core.windows.net/<container>/<file>?<sas-token>" -o file.txt
```
```
azcopy cp "https://<storage_account>.blob.core.windows.net/<container>/<file>?<sas-token>" "/your/path/"
```
![image](https://github.com/user-attachments/assets/b791eb7e-a690-4f70-9b05-8c2176f8fc96)

- list blobs in container from private vm
```
 az storage blob upload \
  --container-name public-container \
  --name file.txt \
  --file file.txt \
  --account-name publicserviceendpoint \
  --sas-token "<your-sas-token>"
```
  ![image](https://github.com/user-attachments/assets/04b04c8f-1a5b-4956-a152-d3a74a262296)

- Command used for testing
  ```
  azcopy list "https://publicserviceendpoint.blob.core.windows.net/public-container?sp=rwl&st=2025-04-17T09:02:59Z&se=2025-04-17T17:02:59Z&spr=https&sv=2024-11-04&sr=c&sig=Gxto7iTCFNYMxjeje7MYuxJbKGrfEZQdy%2Bdg7H2XNYk%3D"
  ```
- Private-vm
 ![image](https://github.com/user-attachments/assets/80e80cd1-4c15-4ec3-83b7-cea373821072)

- Local-vm
 ![image](https://github.com/user-attachments/assets/756a57a1-7495-4e36-9498-9f2480bed311)

- Public-vm
  ![image](https://github.com/user-attachments/assets/b153a05e-7522-47c1-bd05-49165b10d307)

**Note:** From public vm and local storage account can't list the blobs.Because its securedd used only from private-vm. 

# 3. Secure Access Using Private Endpoint

   **Use case:** Complete private connectivity. No public endpoint. Uses Azure backbone only.

   ![image](https://github.com/user-attachments/assets/6327db1b-cb24-41f4-8cf4-65ca77124f44)


**Step 1:** Create Private Endpoint in Storage Account

- Go to storage Account.
- Under "Networking" > Private endpoint connections > + Private Endpoint.

    - Name : storage-privatelink

    - Region :Central India

    - Resource type: Microsoft.Storage/storageAccounts

    - Target sub-resource: blob

    - Under Virtual Network, choose VNet and Private Subnet

    - Choose Integrate with Private DNS Zone (auto-created by Azure)

    - Click Create.
 
**Step 2:** DNS Resolution

 Azure automatically adds DNS entry like :   **<storage_account>.privatelink.blob.core.windows.net → 10.x.x.x**

 So,from the private vm check .It should resolve to a Private IP (10.x.x.x)
 ```
  nslookup <storage_account>.blob.core.windows.net
```
 ![image](https://github.com/user-attachments/assets/8905ac1b-f826-4adf-8c6e-2cc5bede47a1)

**Step 3:** Deny public access to storage account from publi vm
 
 ![image](https://github.com/user-attachments/assets/545b47ca-df69-4960-a9c7-23e19b3f7661)

**Step 4:** Use SAS to Access

Access is the same as public/service endpoint — just now resolved to private IP.
```
curl "https://<storage_account>.blob.core.windows.net/<container>/<file>?<sas-token>" -o file.txt
```
or
```
azcopy cp "https://<storage_account>.blob.core.windows.net/<container>/<file>?<sas-token>" "/your/path/"
```

- Private-vm
  ![image](https://github.com/user-attachments/assets/1c27105d-e6af-41ba-a5cd-7897655f0192)

- Local-vm
  ![image](https://github.com/user-attachments/assets/1dea21e3-7b2e-4b9f-b43d-4a31973ae4e2)

- Public-vm







     
