
# VMSS using load balancers

- Azure Load Balancer is a component in Azure that helps in uniform distribution of load across services.
- Types of Azure Load Balancers
  - **Public Load Balancer:** A load balancer that is exposed to the internet is the public load balancer.
  - **Internal Load Balancer:** A load balancer that is only available inside the network and not available through the internet is the internal load balancer. It is mainly used for internal traffic splitting.

 ## Architecture Diagram

![3tier draw](https://github.com/user-attachments/assets/14a94f7b-0dde-4a4b-8af4-1f62b70ce01c)

## Steps to configure azure load balancer in vmss

### Road map:

1.Create Resourse group

2.Create NAT

3.Create NSG

4.Create virtual network

5.Create 2 private subnet's ,attach NAT and NSG

6.Create frontend public load balancer

7.Create backend public load balancer

8.Create azure mysql flexible server

9.Create frontend vmss

9.Create backend vmss

10.Check in browser

# Step -1 :Create resourse group :**rg-vmss-ranjitha**

# Step -2:Create NSG
![image](https://github.com/user-attachments/assets/da5a9ac8-e9b7-45dd-af28-6280ac19c557)

# Step -3: Create virtual network:**vmss-vnet**

# Step -4:Create frontend subnet

![image](https://github.com/user-attachments/assets/139ba742-10c9-47c4-8b3a-5b89ca5c7caa)
#### Add private subnet,NAT,Nsg

![image](https://github.com/user-attachments/assets/8778a59f-d08e-4979-9a38-05bb63122318)

## Create backend subnet

![image](https://github.com/user-attachments/assets/31056f24-ac8d-4dab-829b-9132fae74b64)

#### Add private subnet,NSG,NAT

![image](https://github.com/user-attachments/assets/b724c96e-c3b2-4b1e-9610-c2fadcb1f9e0)

# Step 5:Create Frontend load balancer

![image](https://github.com/user-attachments/assets/0b5a3d94-90d5-402c-b0b0-8c38df6cb647)

![image](https://github.com/user-attachments/assets/0dc2826f-600a-4c80-82a3-eb08aa760fc6)

**NEXT:Backend pools**

![image](https://github.com/user-attachments/assets/04a6a9e9-898c-42bf-96c1-780073234308)

**NEXT:Health probes**

![image](https://github.com/user-attachments/assets/6d44a171-5c6a-4287-9c0a-1b85bfeb626b)

**NEXT:Load Balancing Rules**

![image](https://github.com/user-attachments/assets/454d9b79-5d45-44d2-a137-5f98a5c680c0)
![image](https://github.com/user-attachments/assets/fa51416a-81ea-4a06-8dad-748c8de09746)

**NEXT:Outbound Rules**

![image](https://github.com/user-attachments/assets/681c88b3-12d5-4125-ba21-e22665b4a5ce)
![image](https://github.com/user-attachments/assets/404a9a89-f0bc-4a7b-9d43-52676280fafc)

# Step -6:Create Backend Load balancer
![image](https://github.com/user-attachments/assets/1df51568-e3ed-4814-8f26-fa899eeb58bb)

**NEXT:Frontend ip-configuration**

![image](https://github.com/user-attachments/assets/82747947-e7fd-4df8-a8ee-2824c71d93bf)

**NEXT:Backend pools**
![image](https://github.com/user-attachments/assets/31ede0de-a8ab-4294-8a3d-865d631d0550)

**NEXT:Health probes**

![image](https://github.com/user-attachments/assets/493b9f08-28b4-4526-9eb9-f1f4fc16abc9)

**NEXT:Load balancing rules**
![image](https://github.com/user-attachments/assets/216ff331-3098-4c51-81dc-5653b0116364)
![image](https://github.com/user-attachments/assets/7fcb4a11-59c9-4ef1-9a28-7a1a82b8f541)

**NEXT:Outbound-rules**

![image](https://github.com/user-attachments/assets/e0e74137-a8df-41aa-84e5-1fe3a283ef49)
![image](https://github.com/user-attachments/assets/1489a3ad-55d0-4f19-8d79-d1ad68701d1a)

# Step -7: Azure database mysql flexible server
![image](https://github.com/user-attachments/assets/2ba8ccf0-34c6-480b-af31-9d55599f74f9)

# Step -: Create virtual machine scale set for frontend

![image](https://github.com/user-attachments/assets/bfeb0fdc-393f-4d27-b8bc-44ae10e56fe7)
![image](https://github.com/user-attachments/assets/05e16e36-dd94-4cac-9cc1-646df4b8e256)
![image](https://github.com/user-attachments/assets/fb33ee1b-3a3c-46d2-88d3-bb09f741cedf)

**NEXT:Networking**

![image](https://github.com/user-attachments/assets/5ccfe1be-b142-47c9-836e-9bb11000b18c)

#### Edit the network interface --->choose the subnet --->no need NSG(because NSG attached with subnet) --->disabled public ip

![image](https://github.com/user-attachments/assets/b805d7a2-2548-498c-8d29-4a23e7363fef)
![image](https://github.com/user-attachments/assets/540e5c8f-fd45-48a8-8ce0-c864ee4fa2c3)

**NEXT:Health**

![image](https://github.com/user-attachments/assets/6015c887-5fc4-48b0-94d1-4d7845a7b629)

**NEXT:Advanced**

#### Enable "user data" and add frontend shell script

![image](https://github.com/user-attachments/assets/f088145d-122b-4201-8b42-eb8681c2fc7a)

USER DATA
```
#!/bin/bash

# Variables
GIT_REPO="https://Ranjitha75388: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@github.com/Ranjitha75388/ranjitha_assesment.git"
APP_DIR="/home/ranjitha/ranjitha_assesment"
NODE_VERSION="18"

# Update system packages
echo "Updating system packages..."
sudo apt update && sudo apt upgrade -y

# Install Node.js and npm
echo "Installing Node.js and npm..."
curl -fsSL https://deb.nodesource.com/setup_$NODE_VERSION.x | sudo -E bash -
sudo apt -y install nodejs
node -v && npm -v

# Clone the frontend application from GitHub
echo "Cloning frontend repository..."
git clone --depth 1 $GIT_REPO $APP_DIR

# Navigate to application directory
cd $APP_DIR/ems-ops-phase/react-hooks-frontend

# Set Node.js options for OpenSSL (in case of legacy OpenSSL issues)
export NODE_OPTIONS=--openssl-legacy-provider

# Remove cache
rm -rf node_modules package-lock.json

# Install dependencies
echo "Installing frontend dependencies..."
npm install

# Build the frontend
echo "Building frontend..."
npm start &

# Create a systemd service for the frontend
echo "Creating systemd service..."
SERVICE_FILE="/etc/systemd/system/frontend.service"

sudo bash -c "cat > $SERVICE_FILE" <<EOF
[Unit]
Description=React Frontend Application
After=network.target

[Service]
ExecStart=/usr/bin/bash -c 'npm start'
WorkingDirectory=$APP_DIR/ems-ops-phase/react-hooks-frontend
Restart=always
RestartSec=5
User=ranjitha
Environment=NODE_OPTIONS=--openssl-legacy-provider
StandardOutput=syslog
StandardError=syslog
SyslogIdentifier=frontend-app

[Install]
WantedBy=multi-user.target
EOF

# Reload systemd and enable the service
sudo systemctl daemon-reload
sudo systemctl enable frontend.service
sudo systemctl start frontend.service

echo "Frontend setup completed successfully!"
echo "Check service status: sudo systemctl status frontend.service"
```

**Review+create**

### Network settings ---> Add inbound rules

![image](https://github.com/user-attachments/assets/03edc12e-dc12-4e65-872c-c8fe95771638)

### Update in frontend instance:cd /ranjitha_assesment/ems-ops-phase/react-hooks-frontend/src/services/Employeeservice.js ----->modify localhost to backend load balancer ip

![image](https://github.com/user-attachments/assets/b71d6f43-1ff2-4276-b08e-b395fc89cf2f)

# Step -8: Create virtual machine scale set for backend

![image](https://github.com/user-attachments/assets/ba086d2f-cc7f-4506-9d28-d9c0a726c0a3)

**NEXT:Networking**

#### Edit Networking interface ---> choose backend subnet ---> NIC (none) ---> Disabled public ip(because private subnet,no need public ip)

![image](https://github.com/user-attachments/assets/e18d002b-7d7c-4595-94d8-307fa06e781a)

#### Need to connect load balancing

![image](https://github.com/user-attachments/assets/e4ffc26b-dc40-4706-918c-d1f799d41aa9)

**NEXT:Advanced**

#### Enable user data and add spring boot shell script

![image](https://github.com/user-attachments/assets/9dbfa0b4-2433-4698-9cff-0e71e0c5a98b)

USER DATA
```
#!/bin/bash

# Variables
GIT_REPO="https://Ranjitha75388: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@github.com/Ranjitha75388/ranjitha_assesment.git"     ##### https method
# GIT_REPO="git@github.com:Ranjitha75388/ranjitha_assesment.git"      ####### ssh method
APP_DIR="/home/ranjitha/ranjitha_assesment"
SPRING_BOOT_DIR="$APP_DIR/ems-ops-phase/springboot-backend"
JAVA_VERSION="17"
MAVEN_VERSION="3.8.8"
DB_URL="jdbc:mysql://mysql-server-demo.mysql.database.azure.com:3306/new_flexible_db?useSSL=true&requireSSL=true&verifyServerCertificate=true"
DB_USERNAME="ranjitha"
DB_PASSWORD="tharshik@123"

# Update system packages
echo "Updating system packages..."
sudo apt update && sudo apt upgrade -y

# Install Java Development Kit (JDK)
echo "Installing OpenJDK $JAVA_VERSION..."
sudo apt -y install openjdk-$JAVA_VERSION-jdk
java -version

# Install Apache Maven
echo "Installing Apache Maven $MAVEN_VERSION..."
cd /opt
sudo wget https://dlcdn.apache.org/maven/maven-3/$MAVEN_VERSION/binaries/apache-maven-$MAVEN_VERSION-bin.tar.gz
sudo tar -xvzf apache-maven-$MAVEN_VERSION-bin.tar.gz
sudo mv apache-maven-$MAVEN_VERSION apache-maven
sudo rm apache-maven-$MAVEN_VERSION-bin.tar.gz

# Set environment variables for Maven
echo "Setting up Maven environment variables..."
export M2_HOME=/opt/apache-maven
export PATH=$M2_HOME/bin:$PATH

# Verify Maven installation
mvn -version

# Clone the backend application from GitHub (if not already cloned)
echo "Cloning backend repository..."
git clone --depth 1 $GIT_REPO $APP_DIR

# Navigate to Spring Boot backend directory
cd $SPRING_BOOT_DIR

# Update application.properties with database details
echo "Configuring database connection..."
cat <<EOL > src/main/resources/application.properties
spring.datasource.url=$DB_URL
spring.datasource.username=$DB_USERNAME
spring.datasource.password=$DB_PASSWORD
spring.jpa.properties.hibernate.dialect=org.hibernate.dialect.MySQLDialect
spring.jpa.hibernate.ddl-auto=update
EOL

# Install dependencies with Maven
echo "Building Spring Boot application using Maven..."
mvn clean install -DskipTests

# Check if the JAR file exists in the target directory
JAR_FILE=$(find target -name "*.jar" -print -quit)

if [ -z "$JAR_FILE" ]; then
  echo "Error: JAR file not found in target directory."
  exit 1
fi

# Run the Spring Boot application JAR file
echo "Running the Spring Boot application from JAR file..."
java -jar $JAR_FILE

echo "Spring Boot backend setup completed successfully!"

# Create a systemd service file for the application
echo "Creating systemd service file..."
sudo bash -c "cat > /etc/systemd/system/springboot-backend.service" <<EOL
[Unit]
Description=Spring Boot Backend Application
After=network.target

[Service]
User=ranjitha
ExecStart=/usr/bin/java -jar $SPRING_BOOT_DIR/$JAR_FILE
SuccessExitStatus=143
Restart=on-failure
RestartSec=10
Environment=SPRING_PROFILES_ACTIVE=prod

[Install]
WantedBy=multi-user.target
EOL
# Reload systemd to apply the new service
echo "Reloading systemd daemon..."
sudo systemctl daemon-reload

# Enable and start the service
echo "Enabling and starting the springboot-backend service..."
sudo systemctl enable springboot-backend
sudo systemctl start springboot-backend

echo "Spring Boot backend setup and service configuration completed successfully!"
```
**Review+Create**

### Network setting ---> Add inbound rules

![image](https://github.com/user-attachments/assets/febb38b0-92c2-4e3c-90b3-e2625e006dc6)

# Step -9:check in browser with frontend load balancer public ip

![image](https://github.com/user-attachments/assets/9adda973-88a4-4e09-85e2-fca529e7d3ec)

![image](https://github.com/user-attachments/assets/b225eb2c-02f7-4a03-9bde-ee79abf6faa8)


### After Adding employee details check data is added in mysql server

![image](https://github.com/user-attachments/assets/c27883b6-78a0-40ba-af2e-ca14cbe1bd50)


### Add instance count in manual scalling and save it

![image](https://github.com/user-attachments/assets/397591f6-88a6-443b-99bf-dc839016d9bb)

### Check instance added in vmss-frontend ---- Instance

![image](https://github.com/user-attachments/assets/7a1ca704-45f8-4489-8261-38f356d3561b)



# NOTE: 
More than 4 ip's cannnot create in free trail.
