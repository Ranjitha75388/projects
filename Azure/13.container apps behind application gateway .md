# Container apps behind Application gateway

Refer https://blog.esoxsolutions.nl/2023/06/11/azure-container-apps-going-through-the-gateway/

**Step 1:** Create Resourse group :rg-ranjitha

**Step 2 :** Create Container Registry

**Step 3 :** Push images to Registry using github actions

Refer [https://github.com/Ranjitha75388/projects/blob/main/Azure/12%20.%20Container%20app%20.md]

**Step 4 :** Create Virtual Network with Subnets and NSG

![image](https://github.com/user-attachments/assets/77658f6e-cfdc-4997-84d4-63842405f141)


**Step 5 :** Create Frontend-container app

![image](https://github.com/user-attachments/assets/84000785-86d3-44c4-b85f-9b7e0a4f7213)
![image](https://github.com/user-attachments/assets/e70c0c54-b766-443d-b59c-3343d98477bc)

   - ### Create container Apps environment
   ![image](https://github.com/user-attachments/assets/e6023cb9-706c-4388-8f9a-31273101ce17)

   - ### Networking
   ![image](https://github.com/user-attachments/assets/7f27c25b-fb48-45a1-bc27-966a5d8c2778)

   - Click Create

- ### Next:Container
![image](https://github.com/user-attachments/assets/caaa3676-9f95-4d59-9319-b3526f5de09c)

- ### Next Click Ingress

![image](https://github.com/user-attachments/assets/8592bd70-d26b-4ae4-a647-b27d8b4bd8a0)

**Review+Create**

**Step 6 :** Copy Domain name and StaticIP

- Go to created container-apps Environment and click JSON View on upper Right corner

    ![image](https://github.com/user-attachments/assets/a93ac79b-a078-4dbe-aed9-b4e775b37346)

- Copy the Defaultdomain and static IP

   ![Screenshot from 2025-03-20 21-01-06](https://github.com/user-attachments/assets/9e16eacc-6e2b-4e93-868c-8b11ddfda060)

**Step 7 :** Create private DNS Zone

- Paste the Defaultdomain(Step:6) in Instance Details ---> Name

![image](https://github.com/user-attachments/assets/99f08bce-92ea-4635-997d-06688c95b9b2)

- Review+Create

 - ### Add A Record set

 - Enter name * and @ and add ip address as staticIP copied above from JSON View (Step 6)

 ![image](https://github.com/user-attachments/assets/b30deefe-ceec-4985-92bc-b522ec347aeb)

### Add virtual network links

![image](https://github.com/user-attachments/assets/4dcadc03-b80a-4edc-9bc3-89c3b4751051)
![image](https://github.com/user-attachments/assets/0b2bdbf9-1f27-42bc-901e-ef984ec5009f)

### Check in terminal

- Check DNS works inside vm created in same vnvet
```
   nslookup frontend-container.orangesea-26381e22.centralindia.azurecontainerapps.io
```
 ![image](https://github.com/user-attachments/assets/5108340c-d8a1-4bf1-baa4-f030021bf004)


**Step 8 :** Create Application Gateway

![image](https://github.com/user-attachments/assets/56045864-3096-4578-98b2-cf17e2327e48)
![image](https://github.com/user-attachments/assets/9b8e7720-8c9c-4934-83ea-ea50fc685fb7)

**2.Frontends**

![image](https://github.com/user-attachments/assets/2ba2a5a5-1e10-4c22-9ccc-ef0bb7b6c20c)

**3.Backends**

Choose IP address of FQDN (Full Qualified Domain Name) and paste the Application URL of the Frontend container app, and remove the https:// at the beginning of the URL

![image](https://github.com/user-attachments/assets/45dc076d-4a9f-4015-97ba-1f32c7e76ca5)

**4.Configuration**

- Add Routing rule

![image](https://github.com/user-attachments/assets/968153c6-a2dd-4f51-8385-91951a2c243a)

- Backend-target  ---->Backend settings (Refer Below for HTTPS Settings)

![image](https://github.com/user-attachments/assets/57d7eb3b-350f-41b1-a4b0-90d7d06abcea)
![image](https://github.com/user-attachments/assets/a6bd1166-455a-4de1-8b60-57e86e17fbaa)

- Add a path rule for frontend:/*

![image](https://github.com/user-attachments/assets/476d3bd3-4729-4e85-99b6-6fd7ff62c3ba)

**Review+create**

### Add private link

![image](https://github.com/user-attachments/assets/898d8755-961c-480d-8651-7b0c16232cd6)

Add

### Check health probes

![image](https://github.com/user-attachments/assets/ce0aafcc-a26b-4b9f-9304-652ffd6099f0)
![image](https://github.com/user-attachments/assets/aa32268c-cbd3-45ea-9dbe-362fde1483e2)

**Step 9 :** check inside vm

```
   curl -I https://frontend-container.orangesea-26381e22.centralindia.azurecontainerapps.io
```
![image](https://github.com/user-attachments/assets/ea0c4545-cbff-4bef-991f-5dafd742eafb)

**Step 10:** Check in browser

Copy Application gateway public-ip
```
https://135.235.212.114:3000/
```
![Screenshot from 2025-03-20 15-45-58](https://github.com/user-attachments/assets/aee0812f-9516-43a0-972c-d4991fd951f7)

 

### OPTIONAL (Above Tried HTTPS insteed of HTTP )

#### Step-by-Step: Get Free SSL & Enable HTTPS on Azure Application Gateway

Step 1: Install OpenSSL (If Not Already Installed)

Run these commands on your local machine to ensure OpenSSL is installed:
```
sudo apt update
sudo apt install openssl -y
```
Step 2: Generate a Self-Signed SSL Certificate

Run the following command to generate a self-signed SSL certificate for your domain:
replace CN=Domain name
```
openssl req -x509 -nodes -days 365 -newkey rsa:2048 \
-keyout mycert.key -out mycert.crt -subj "/CN=orangesea-26381e22.centralindia.azurecontainerapps.io"
```
This creates:

    mycert.key → Private Key
    mycert.crt → SSL Certificate
Step 3: Convert SSL Certificate to PFX Format (Required for Azure)

Azure only accepts .pfx format, so convert your SSL certificate:
```
openssl pkcs12 -export -out mycert.pfx -inkey mycert.key -in mycert.crt
```
You will be asked for a password → Remember this password!

 This creates:

    mycert.pfx → SSL Certificate in PFX format

![image](https://github.com/user-attachments/assets/248577ac-4412-4dcc-b009-ab52b1fd6338)

Step 4: Upload SSL Certificate to Azure Application Gateway

Now, go to Azure Portal and upload the certificate:

   - Go to Azure Application Gateway
   - Click on "Listeners" → Add a new HTTPS Listener
   - Select HTTPS as the protocol
   - Upload mycert.pfx file
   - Enter the password (the one you set during conversion)
   - Click Save

 Step 5: Configure Backend & HTTPS Routing

 -   Go to "Backend Pools" → Select your frontend container app
  -  Set Backend Port: 3000 (if your React app runs on 3000)
   - Go to "HTTP Settings"
       -    Enable HTTPS (443)
       - Select the same SSL certificate
 -   Go to "Rules"
        Create a new routing rule for HTTPS

## Backend container

Follow all the steps from above.

**Step 11 :** Create Backend container
  
**Step 12:** Create private DNS for Backend container FDQN.

   Copy Domain name and ip address from Backend-container JSON View

**Step 13:** Add Application Gateway

  Add Backend container FDQN in Application-gateway backend pool.

**Step 14 :** Update in react-hooks-frontend

- In Reacthooks-frontend ---> cd src/service/employee.service.js
- Replace with backend-container URL
- Check in browser with [Application-gateway public-ip /api/v1/empliyees].
  
  

