# VMSS

- Typically, We will create each virtual machine manually. But what if we want to create 100s of similar VMs? It’s time-consuming and requires lots of human effort. This is possible with the help of Virtual Machine Scale Sets (VMSS). 
- VMSS is a service provided by Microsoft Azure that allows us to create, manage and monitor multiple Virtual Machines of similar properties.
- We can also scale up or scale down the number of VMs in a VMSS based on our requirements.
-  It helps in auto-scaling, high availability, and load balancing.

## Scaling Policies in VMSS

**1.Manual Scaling**

-  Manual Scaling requires human intervention for scaling up or down instances in a Virtual Machine Scale Set.

-  You can scale horizontally or vertically based on your requirement.

**Example**: You manually scale from 2 VMs to 5 VMs when traffic increases.

**2.Auto-Scaling (Dynamic Scaling)**

- Scaling of Virtual Machines in a VMSS is done automatically where you can set rules to trigger the scaling feature.

- You can set a threshold on the number of instances that can be created by providing conditions.

## Scaling methods:

![image](https://github.com/user-attachments/assets/a433b721-358e-47f1-8989-7209f1d30618)


### 1. Vertical Scaling (Scale Up / Scale Down)

   **Definition:** Increasing or decreasing the size (capacity) of an existing virtual machine (VM).

   **How it works:**
       
  - Scale Up = Add more CPU, RAM, or disk to an existing VM.
      
  - Scale Down = Reduce CPU, RAM, or disk of an existing VM.

  **Example:**
      
  -  Scale Up: A 2-core, 8GB RAM VM is upgraded to 4-core, 16GB RAM.
      
  - Scale Down: A 4-core, 16GB RAM VM is reduced to 2-core, 8GB RAM.

### 2.Horizontal Scaling (Scale Out / Scale In)

   **Definition:** Increasing or decreasing the number of VM instances in a scale set.

   **How it works:**
      
  - Scale Out = Add more VMs to handle increased traffic.

  - Scale In = Remove VMs when demand decreases.

  **Example:**
    
  - Scale Out: A 3-VM increases to 10 VMs during peak hours.

  - Scale In: A 10-VM reduces to 3 VMs during low traffic.

### 3. Scheduled Scaling

- VMs scale at specific times based on a predefined schedule.
 
- Useful for businesses with known peak and off-peak hours.

- Best for:

  - E-commerce websites (increase VMs during sales events).
  - Banking apps (scale up during working hours).
  - Batch processing jobs (run workloads at night).

 **Example:**

  - Scale to 10 VMs from 9 AM to 5 PM (business hours).
  
  - Scale down to 2 VMs from 5 PM to 9 AM (off-hours).

 **How to Configure (Azure Portal)**

  - Go to VM Scale Set → Scaling
  -  Select Scheduled Scaling
  -  Choose Start Time, End Time, and Scale Count
  -  Click Apply

### 4.Predictive Scaling (AI-Based Scaling)

- Uses machine learning (ML) algorithms to predict future demand.

- Analyzes historical usage patterns to automatically adjust scaling.

- Reduces sudden traffic spikes by scaling in advance.

- Best for:

    - Applications with seasonal or event-driven traffic patterns.

    - Large-scale e-commerce sites (predicts demand based on past traffic).

**Example:**

   - Azure ML predicts a traffic surge at 6 PM, so it prepares extra VMs at 5:45 PM.

**How to Enable Predictive Scaling (Azure Monitor)**

  -  Go to Azure Monitor → Auto-Scale Settings
  
  -  Select Predictive Scaling
  
  -  Choose a Time Window (historical data for training the model)

  - Click Enable

## Creating vmss in Azure portal

### Frontend vmss
![image](https://github.com/user-attachments/assets/a3325b88-2a19-45a6-ba95-bca2c77365b9)

![image](https://github.com/user-attachments/assets/6107638a-3a78-4a32-a701-9c6f0255c465)


![image](https://github.com/user-attachments/assets/0e32ab2f-9795-45eb-9569-4937a482ec68)
![image](https://github.com/user-attachments/assets/08959e01-5f9f-4e39-9596-f493ed14953b)
![image](https://github.com/user-attachments/assets/4610d1a6-5a02-4f35-8a8e-4892aada217c)

#### Advanced
![image](https://github.com/user-attachments/assets/38c75d8c-abed-49fc-90da-b61e307cbf5e)

#### user data script
```
#!/bin/bash

# Variables
GIT_REPO="https://Ranjitha75388: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@github.com/Ranjitha75388/ranjitha_assesment.git"
APP_DIR="/home/ranjitha/ranjitha_assesment"
NODE_VERSION="18"

# Update system packages
echo "Updating system packages..."
sudo apt update && sudo apt upgrade -y

# Install Node.js and npm
echo "Installing Node.js and npm..."
curl -fsSL https://deb.nodesource.com/setup_$NODE_VERSION.x | sudo -E bash -
sudo apt -y install nodejs
node -v && npm -v

# Clone the frontend application from GitHub
echo "Cloning frontend repository..."
git clone --depth 1 $GIT_REPO $APP_DIR

# Navigate to application directory
cd $APP_DIR/ems-ops-phase/react-hooks-frontend

# Set Node.js options for OpenSSL (in case of legacy OpenSSL issues)
export NODE_OPTIONS=--openssl-legacy-provider

# Install dependencies
echo "Installing frontend dependencies..."
npm install

# Build the frontend
echo "Building frontend..."
npm start &

# Create a systemd service for the frontend
echo "Creating systemd service..."
SERVICE_FILE="/etc/systemd/system/frontend.service"

sudo bash -c "cat > $SERVICE_FILE" <<EOF
[Unit]
Description=React Frontend Application
After=network.target

[Service]
ExecStart=/usr/bin/npm start
WorkingDirectory=$APP_DIR/ems-ops-phase/react-hooks-frontend
Restart=always
User=ranjitha
Environment=NODE_OPTIONS=--openssl-legacy-provider
StandardOutput=syslog
StandardError=syslog
SyslogIdentifier=frontend-app

[Install]
WantedBy=multi-user.target
EOF

# Reload systemd and enable the service
sudo systemctl daemon-reload
sudo systemctl enable frontend.service
sudo systemctl start frontend.service

echo "Frontend setup completed successfully!"
echo "Check service status: sudo systemctl status frontend.service"
```
#### NSG inbound rules

![image](https://github.com/user-attachments/assets/fac9e1e2-3e2d-4758-9f25-60ed2eb1c265)

#### After vmss created instance will be created inside vmss

![image](https://github.com/user-attachments/assets/5f18124f-cd2f-455a-a86c-91ce985c6b7a)

![image](https://github.com/user-attachments/assets/7c7f4a4b-44da-43ea-97ef-c28ecb5b685b)

![image](https://github.com/user-attachments/assets/7892ebaf-2ca4-4c59-aa75-dae0791e696f)


### Backend vmss

![image](https://github.com/user-attachments/assets/9ba0abfc-8a74-4702-8269-202870499a17)

![image](https://github.com/user-attachments/assets/bae84bec-2661-41f3-b2dd-ac740986c62c)

![image](https://github.com/user-attachments/assets/a35eba21-c9e7-4ee3-b423-04267fd07926)

#### NEXT:Networking

![image](https://github.com/user-attachments/assets/85f2feaf-3f4e-4710-8cd3-11feeda68265)

**NEXT:Health**

![image](https://github.com/user-attachments/assets/afcd996c-a8b7-4d85-8c61-b96c3dc71326)

**NEXT:Advanced**

![image](https://github.com/user-attachments/assets/8b5cce96-ca01-4705-87ad-8ea713963a2e)

**user data script**
```
#!/bin/bash

# Variables
GIT_REPO="https://Ranjitha75388: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@github.com/Ranjitha75388/ranjitha_assesment.git"     ##### https method
# GIT_REPO="git@github.com:Ranjitha75388/ranjitha_assesment.git"      ####### ssh method
APP_DIR="/home/ranjitha/ranjitha_assesment"
SPRING_BOOT_DIR="$APP_DIR/ems-ops-phase/springboot-backend"
JAVA_VERSION="17"
MAVEN_VERSION="3.8.8"
DB_URL="jdbc:mysql://mysql-server-demo.mysql.database.azure.com:3306/new_flexible_db?useSSL=true&requireSSL=true&verifyServerCertificate=true"
DB_USERNAME="ranjitha"
DB_PASSWORD="tharshik@123"

# Update system packages
echo "Updating system packages..."
sudo apt update && sudo apt upgrade -y

# Install Java Development Kit (JDK)
echo "Installing OpenJDK $JAVA_VERSION..."
sudo apt -y install openjdk-$JAVA_VERSION-jdk
java -version

# Install Apache Maven
echo "Installing Apache Maven $MAVEN_VERSION..."
cd /opt
sudo wget https://dlcdn.apache.org/maven/maven-3/$MAVEN_VERSION/binaries/apache-maven-$MAVEN_VERSION-bin.tar.gz
sudo tar -xvzf apache-maven-$MAVEN_VERSION-bin.tar.gz
sudo mv apache-maven-$MAVEN_VERSION apache-maven
sudo rm apache-maven-$MAVEN_VERSION-bin.tar.gz

# Set environment variables for Maven
echo "Setting up Maven environment variables..."
export M2_HOME=/opt/apache-maven
export PATH=$M2_HOME/bin:$PATH

# Verify Maven installation
mvn -version

# Clone the backend application from GitHub (if not already cloned)
echo "Cloning backend repository..."
git clone --depth 1 $GIT_REPO $APP_DIR

# Navigate to Spring Boot backend directory
cd $SPRING_BOOT_DIR

# Update application.properties with database details
echo "Configuring database connection..."
cat <<EOL > src/main/resources/application.properties
spring.datasource.url=$DB_URL
spring.datasource.username=$DB_USERNAME
spring.datasource.password=$DB_PASSWORD
spring.jpa.properties.hibernate.dialect=org.hibernate.dialect.MySQLDialect
spring.jpa.hibernate.ddl-auto=update
EOL

# Install dependencies with Maven
echo "Building Spring Boot application using Maven..."
mvn clean install -DskipTests

# Check if the JAR file exists in the target directory
JAR_FILE=$(find target -name "*.jar" -print -quit)

if [ -z "$JAR_FILE" ]; then
  echo "Error: JAR file not found in target directory."
  exit 1
fi

# Run the Spring Boot application JAR file
echo "Running the Spring Boot application from JAR file..."
java -jar $JAR_FILE

echo "Spring Boot backend setup completed successfully!"

# Create a systemd service file for the application
echo "Creating systemd service file..."
sudo bash -c "cat > /etc/systemd/system/springboot-backend.service" <<EOL
[Unit]
Description=Spring Boot Backend Application
After=network.target

[Service]
User=ranjitha
ExecStart=/usr/bin/java -jar $SPRING_BOOT_DIR/$JAR_FILE
SuccessExitStatus=143
Restart=on-failure
RestartSec=10
Environment=SPRING_PROFILES_ACTIVE=prod

[Install]
WantedBy=multi-user.target
EOL
# Reload systemd to apply the new service
echo "Reloading systemd daemon..."
sudo systemctl daemon-reload

# Enable and start the service
echo "Enabling and starting the springboot-backend service..."
sudo systemctl enable springboot-backend
sudo systemctl start springboot-backend

echo "Spring Boot backend setup and service configuration completed successfully!"

```

**Review + create**


## NOTE :

Without any load balancer backend will not work in browser.
